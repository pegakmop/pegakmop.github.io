<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä VLESS-—Å—Å—ã–ª–∫–∏ –∏–∑ JSON</title>
<style>
  body { font-family: Arial, sans-serif; margin: 1em; background: #fafafa; }
  textarea { width: 100%; height: 200px; font-family: monospace; font-size: 1rem; padding: 0.5em; box-sizing: border-box; }
  input[type="text"], button {
    font-size: 1rem;
    padding: 0.5em;
    margin-top: 0.5em;
  }
  button {
    background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;
    width: 100%;
  }
  button:active {
    background-color: #0056b3;
  }
  #result {
    margin-top: 1em;
    background: white;
    padding: 1em;
    border-radius: 8px;
    box-shadow: 0 0 6px rgba(0,0,0,0.1);
    word-break: break-word;
    position: relative;
  }
  #resultText {
    user-select: all;
  }
  #copyBtn {
    position: absolute;
    top: 1em;
    right: 1em;
    background: #28a745;
    border: none;
    color: white;
    padding: 0.3em 0.6em;
    border-radius: 4px;
    font-weight: bold;
    cursor: pointer;
  }
  #copyBtn:active {
    background: #1e7e34;
  }
</style>
</head>
<body>
<p><button style="font-size:12px;" onclick="history.back();return false;"> üîô –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é </button></p>
<h2>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä vless:// –∫–ª—é—á–∞ –∏–∑ amneziavpn –ø—Ä–æ—Ç–æ–∫–æ–ª xray –∏ —Ñ–æ—Ä–º–∞—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç xray amnezia_for_xray.json</h2>

<textarea id="jsonInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–º JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å—é–¥–∞ amnezia_for_xray.json"></textarea>
<br />
<label hidden for="customName">–ù–∞–∑–≤–∞–Ω–∏–µ (–±—É–¥–µ—Ç –ø–æ—Å–ª–µ #, –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
<input hidden type="text" id="customName" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, telegram-reality" />
<button id="generateBtn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å VLESS-—Å—Å—ã–ª–∫—É</button>

<div id="result" style="display:none;">
  <div id="resultText" tabindex="0" role="textbox" aria-label="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è VLESS-—Å—Å—ã–ª–∫–∞"></div>
  <button id="copyBtn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
</div>

<script>
function safeGet(obj, path, defaultValue = '') {
  return path.reduce((acc, key) => (acc && acc[key] !== undefined) ? acc[key] : defaultValue, obj);
}

function generateVlessLink(data, customName) {
  const uuid = safeGet(data, ['outbounds', 0, 'settings', 'vnext', 0, 'users', 0, 'id']);
  const host = safeGet(data, ['outbounds', 0, 'settings', 'vnext', 0, 'address']);
  const port = safeGet(data, ['outbounds', 0, 'settings', 'vnext', 0, 'port']);
  const flow = safeGet(data, ['outbounds', 0, 'settings', 'vnext', 0, 'users', 0, 'flow'], '');
  const encryption = safeGet(data, ['outbounds', 0, 'settings', 'vnext', 0, 'users', 0, 'encryption'], 'none');
  const security = safeGet(data, ['outbounds', 0, 'streamSettings', 'security']);
  const net = safeGet(data, ['outbounds', 0, 'streamSettings', 'network']);
  const sni = safeGet(data, ['outbounds', 0, 'streamSettings', 'realitySettings', 'serverName']);
  const fp = safeGet(data, ['outbounds', 0, 'streamSettings', 'realitySettings', 'fingerprint']);
  const pbk = safeGet(data, ['outbounds', 0, 'streamSettings', 'realitySettings', 'publicKey']);
  const sid = safeGet(data, ['outbounds', 0, 'streamSettings', 'realitySettings', 'shortId'], '');

  if (!uuid || !host || !port || !security || !net) {
    return null;
  }

  const flowParam = flow ? `&flow=${encodeURIComponent(flow)}` : '';
  const sidParam = sid ? `&sid=${encodeURIComponent(sid)}` : '';

  let name = customName.trim();
  if (!name) {
    name = safeGet(data, ['name'], '') || safeGet(data, ['outbounds', 0, 'tag'], '') || 'amnezia_for_xray.json-xray-to-vless-create-by-@pegakmop';
  }

  const url = `vless://${uuid}@${host}:${port}?encryption=${encryption}&security=${security}&type=${net}${flowParam}&sni=${encodeURIComponent(sni)}&fp=${encodeURIComponent(fp)}&pbk=${encodeURIComponent(pbk)}${sidParam}#${encodeURIComponent(name)}`;

  return url;
}

document.getElementById('generateBtn').addEventListener('click', () => {
  const jsonText = document.getElementById('jsonInput').value.trim();
  const customName = document.getElementById('customName').value;
  const resultDiv = document.getElementById('result');
  const resultText = document.getElementById('resultText');

  if (!jsonText) {
    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Å—Ç–∞–≤—å—Ç–µ JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é');
    return;
  }

  try {
    const data = JSON.parse(jsonText);
    const vlessLink = generateVlessLink(data, customName);

    if (!vlessLink) {
      alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è –≤ JSON –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–∫–∏.');
      resultDiv.style.display = 'none';
      return;
    }

    resultText.textContent = vlessLink;
    resultDiv.style.display = 'block';
  } catch (e) {
    alert('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ JSON: ' + e.message);
    resultDiv.style.display = 'none';
  }
});

document.getElementById('copyBtn').addEventListener('click', () => {
  const resultText = document.getElementById('resultText');
  if (navigator.clipboard) {
    navigator.clipboard.writeText(resultText.textContent).then(() => {
      alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
    }).catch(() => {
      alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é');
    });
  } else {
    // fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
    const range = document.createRange();
    range.selectNode(resultText);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
    try {
      document.execCommand('copy');
      alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
    } catch {
      alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é');
    }
    window.getSelection().removeAllRanges();
  }
});
</script>

</body>
</html>
