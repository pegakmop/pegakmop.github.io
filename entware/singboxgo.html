<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Singbox Tun Config Generator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
  <style>
    /* –ì–ª–æ–±–∞–ª—å–Ω—ã–π box-sizing */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    /* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–º */
    body {
      --bg-color: #f9f9f9;
      --text-color: #333;
      --border-color: #ccc;
      --card-bg: #fff;
      --button-bg: #007BFF;
      --button-text: #fff;

      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    body.dark-theme {
      --bg-color: #1e1e1e;
      --text-color: #c9d1d9;
      --border-color: #555;
      --card-bg: #282c34;
      --button-bg: #444;
      --button-text: #fff;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    button {
      background-color: var(--button-bg);
      color: var(--button-text);
      border: none;
      border-radius: 20px;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
      transition: opacity 0.3s;
    }

    button:hover {
      opacity: 0.9;
    }

    .link-field {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    input[type="text"], textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--card-bg);
      color: var(--text-color);
      transition: border-color 0.3s;
    }

    .config-display {
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .trash-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      background-color: var(--button-bg);
      color: var(--button-text);
      transition: opacity 0.3s;
    }

    .trash-btn:hover {
      opacity: 0.9;
    }

    #warnings {
      color: #ff6b6b;
      margin-top: 10px;
    }

    #theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      background-color: var(--button-bg);
      color: var(--button-text);
      border: none;
      cursor: pointer;
      z-index: 1000;
    }

    @media (min-width: 600px) {
      .container {
        max-width: 600px;
        margin: 0 auto;
      }
    }

    .config-display pre {
      margin: 0;
      padding: 0;
      background: transparent;
      border: none;
    }

    .config-display code {
      display: block;
      padding: 10px;
      font-size: 14px;
      line-height: 1.5;
    }
  </style>
</head>
<body class="dark-theme">
  <div class="container">
    <h1>Singbox Tun Config Generator</h1>

    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="controls">
      <button onclick="addLinkField()">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button onclick="showUploadDialog()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      <button onclick="generateConfig()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
      <button onclick="saveConfig()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ -->
    <input type="file" id="jsonFileInput" accept=".json" style="display:none;">

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ —Å—Å—ã–ª–æ–∫ -->
    <div id="linkFieldsContainer"></div>

    <!-- –ï–¥–∏–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞ -->
    <div id="configDisplay" class="config-display" style="display: none;">
      <pre><code id="output" class="language-json"></code></pre>
    </div>

    <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è -->
    <div id="warnings"></div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã -->
  <button id="theme-toggle" onclick="toggleTheme()">üåì</button>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ highlight.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let config = {};
    let loadedConfig = null;
    let linkFields = [];

    function resizeOutputContainer() {
      const container = document.getElementById('configDisplay');
      if (!container || !container.style.display || container.style.display === 'none') return;

      requestAnimationFrame(() => {
        container.style.height = 'auto';
        container.style.height = Math.min(container.scrollHeight, 600) + 'px';
      });
    }

    function addLinkField() {
      // –û—á–∏—Å—Ç–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
      document.getElementById('configDisplay').style.display = 'none';
      
      // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è
      const container = document.createElement('div');
      container.className = 'link-field';

      // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'vless://...';

      // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'trash-btn';
      deleteBtn.innerHTML = 'üóëÔ∏è';
      deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å —Å—Å—ã–ª–∫—É';
      deleteBtn.addEventListener('click', () => {
        // –£–¥–∞–ª—è–µ–º –ø–æ–ª–µ –∏–∑ DOM –∏ –∏–∑ –º–∞—Å—Å–∏–≤–∞
        container.remove();
        linkFields = linkFields.filter(field => field !== input);
        
        // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ–ª–µ –∏ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ
        if (linkFields.length === 0 && loadedConfig) {
          showLoadedConfig();
        }
      });

      // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
      container.appendChild(input);
      container.appendChild(deleteBtn);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ —Ñ–æ—Ä–º—É
      document.getElementById('linkFieldsContainer').appendChild(container);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –≤ –º–∞—Å—Å–∏–≤
      linkFields.push(input);
    }

    function showUploadDialog() {
      document.getElementById('jsonFileInput').click();
    }

    document.getElementById('jsonFileInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          loadedConfig = JSON.parse(e.target.result);
          
          // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞ —Å—Å—ã–ª–æ–∫
          document.getElementById('linkFieldsContainer').innerHTML = '';
          linkFields = [];
          
          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞ –≤ –æ–±—â–µ–º –æ–∫–Ω–µ
          const output = document.getElementById('output');
          output.textContent = JSON.stringify(loadedConfig, null, 2);
          hljs.highlightElement(output);
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –∫–æ–Ω—Ñ–∏–≥–∞
          const configDisplay = document.getElementById('configDisplay');
          configDisplay.style.display = 'block';
          
          // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É
          resizeOutputContainer();
          
          // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
          document.getElementById('warnings').innerHTML = "";
        } catch (err) {
          document.getElementById('warnings').innerHTML = "–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: " + err.message;
        }
      };
      reader.readAsText(file);
    });

    function updateRouteRules() {
      if (!config.inbounds) return;
      
      let rules = [];
      config.inbounds.forEach(inbound => {
        if (inbound.tag === "tun-in") {
          rules.push({ "inbound": inbound.tag, "outbound": "proxy" });
        } else if (inbound.tag && inbound.tag.startsWith("tun-in-add")) {
          let num = inbound.tag.slice("tun-in-add".length);
          rules.push({ "inbound": inbound.tag, "outbound": "proxy" + num });
        }
      });
      
      config.route = {
        "auto_detect_interface": false,
        "rules": rules,
        "final": "blocked"
      };
    }

    function generateConfig() {
      // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å—Å—ã–ª–∫–∏ –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
      const links = linkFields.map(input => input.value.trim()).filter(link => link !== "");
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
      const uniqueLinks = [...new Set(links)];
      
      if (uniqueLinks.length === 0 && !loadedConfig) {
        document.getElementById('warnings').innerHTML = "–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É VLESS —Å—Å—ã–ª–∫—É –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥";
        return;
      }
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ –æ—Å–Ω–æ–≤—É
      if (loadedConfig) {
        config = JSON.parse(JSON.stringify(loadedConfig));
      } else {
        // –ò–Ω–∞—á–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥
        config = {
          "log": { "disabled": true },
          "inbounds": [],
          "outbounds": []
        };
      }
      
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Å—Å—ã–ª–∫—É
      const regex = /vless:\/\/([^@]+)@([^:]+):(\d+)/;
      let warnings = [];
      let tunCount = (config.inbounds || []).filter(item => item.type === "tun").length;
      
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏
      uniqueLinks.forEach(link => {
        const match = link.match(regex);
        if (match) {
          const uuid = match[1];
          const server = match[2];
          const server_port = parseInt(match[3], 10);
          const parsedUrl = new URL(link);
          const params = new URLSearchParams(parsedUrl.search);
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç
          if (server_port !== 443) {
            warnings.push(`‚ö†Ô∏è –î–ª—è —Å—Å—ã–ª–∫–∏ ${link} —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Ä—Ç 443.`);
          }
          
          // –°–æ–∑–¥–∞–µ–º outbound
          const outbound = {
            "type": "vless",
            "server": server,
            "server_port": server_port,
            "uuid": uuid,
            "flow": params.get("flow") || "xtls-rprx-vision",
            "packet_encoding": "xudp",
            "domain_strategy": "ipv4_only",
            "tag": tunCount === 0 ? "proxy" : `proxy${tunCount}`,
            "tls": {
              "enabled": true,
              "server_name": params.get("sni") || (tunCount === 0 ? server : "cloudflare.com"),
              "utls": {
                "enabled": true,
                "fingerprint": params.get("fp") || "chrome"
              },
              "reality": {
                "enabled": params.get("security") === "reality",
                "public_key": params.get("pbk") || "",
                "short_id": params.get("sid") || ""
              }
            }
          };
          
          // –°–æ–∑–¥–∞–µ–º inbound
          const inbound = {
            "type": "tun",
            "interface_name": tunCount === 0 ? "tun0" : `tun${tunCount}`,
            "address": [`172.19.0.${tunCount + 1}/32`],
            "mtu": 9000,
            "auto_route": false,
            "strict_route": false,
            "domain_strategy": "ipv4_only",
            "endpoint_independent_nat": true,
            "sniff": false,
            "sniff_override_destination": false,
            "stack": "gvisor",
            "tag": tunCount === 0 ? "tun-in" : `tun-in-add${tunCount}`
          };
          
          // –î–æ–±–∞–≤–ª—è–µ–º outbound –∏ inbound –≤ –∫–æ–Ω—Ñ–∏–≥
          config.outbounds.push(outbound);
          config.inbounds.push(inbound);
          tunCount++;
        } else {
          warnings.push("‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç VLESS —Å—Å—ã–ª–∫–∏: " + link);
        }
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º outbound –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
      if (!config.outbounds.some(outbound => outbound.tag === "blocked")) {
        config.outbounds.push({
          "type": "block",
          "tag": "blocked"
        });
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
      updateRouteRules();
      
      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
      if (warnings.length > 0) {
        document.getElementById('warnings').innerHTML = warnings.join("<br>");
      } else {
        document.getElementById('warnings').innerHTML = "";
      }
      
      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
      const output = document.getElementById('output');
      output.textContent = JSON.stringify(config, null, 2);
      hljs.highlightElement(output);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
      const configDisplay = document.getElementById('configDisplay');
      configDisplay.style.display = 'block';
      
      // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É
      resizeOutputContainer();
    }

    function saveConfig() {
      if (!config) {
        document.getElementById('warnings').innerHTML = "–ù–µ—Ç –∫–æ–Ω—Ñ–∏–≥–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è";
        return;
      }
      
      const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'config.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function toggleTheme() {
      document.body.classList.toggle('dark-theme');
    }

    function showLoadedConfig() {
      const output = document.getElementById('output');
      output.textContent = JSON.stringify(loadedConfig, null, 2);
      hljs.highlightElement(output);
      
      const configDisplay = document.getElementById('configDisplay');
      configDisplay.style.display = 'block';
      
      resizeOutputContainer();
    }
  </script>
</body>
</html>
