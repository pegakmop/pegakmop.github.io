// ==UserScript==
// @name         Geo-IP —Å —Ñ–ª–∞–≥–æ–º –∏ —Ä—É—Å—Å–∫–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ —Å—Ç—Ä–∞–Ω
// @namespace    http://tampermonkey.net/
// @version      1.4
// @description  –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç IP, —Å—Ç—Ä–∞–Ω—É (–Ω–∞ —Ä—É—Å—Å–∫–æ–º), —Ñ–ª–∞–≥, –≥–æ—Ä–æ–¥, —Ä–µ–≥–∏–æ–Ω, –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
// @match        *://*/*
// @grant        GM_xmlhttpRequest
// @connect      api.ipify.org
// @connect      api.ipdata.co
// ==/UserScript==

(function () {
    'use strict';

    const getFlagEmoji = (countryCode) => {
        if (!countryCode || countryCode.length !== 2) return 'üè≥Ô∏è';
        return String.fromCodePoint(...[...countryCode.toUpperCase()].map(c => 0x1F1E6 + c.charCodeAt(0) - 65));
    };

    const countryNamesRU = new Map([
        ["AF", "–ê—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω"], ["AL", "–ê–ª–±–∞–Ω–∏—è"], ["DZ", "–ê–ª–∂–∏—Ä"], ["AD", "–ê–Ω–¥–æ—Ä—Ä–∞"], ["AO", "–ê–Ω–≥–æ–ª–∞"],
        ["AR", "–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞"], ["AM", "–ê—Ä–º–µ–Ω–∏—è"], ["AU", "–ê–≤—Å—Ç—Ä–∞–ª–∏—è"], ["AT", "–ê–≤—Å—Ç—Ä–∏—è"], ["AZ", "–ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω"],
        ["BD", "–ë–∞–Ω–≥–ª–∞–¥–µ—à"], ["BY", "–ë–µ–ª–∞—Ä—É—Å—å"], ["BE", "–ë–µ–ª—å–≥–∏—è"], ["BA", "–ë–æ—Å–Ω–∏—è –∏ –ì–µ—Ä—Ü–µ–≥–æ–≤–∏–Ω–∞"], ["BR", "–ë—Ä–∞–∑–∏–ª–∏—è"],
        ["BG", "–ë–æ–ª–≥–∞—Ä–∏—è"], ["CA", "–ö–∞–Ω–∞–¥–∞"], ["CL", "–ß–∏–ª–∏"], ["CN", "–ö–∏—Ç–∞–π"], ["CO", "–ö–æ–ª—É–º–±–∏—è"],
        ["HR", "–•–æ—Ä–≤–∞—Ç–∏—è"], ["CY", "–ö–∏–ø—Ä"], ["CZ", "–ß–µ—Ö–∏—è"], ["DK", "–î–∞–Ω–∏—è"], ["EG", "–ï–≥–∏–ø–µ—Ç"],
        ["EE", "–≠—Å—Ç–æ–Ω–∏—è"], ["FI", "–§–∏–Ω–ª—è–Ω–¥–∏—è"], ["FR", "–§—Ä–∞–Ω—Ü–∏—è"], ["GE", "–ì—Ä—É–∑–∏—è"], ["DE", "–ì–µ—Ä–º–∞–Ω–∏—è"],
        ["GR", "–ì—Ä–µ—Ü–∏—è"], ["HU", "–í–µ–Ω–≥—Ä–∏—è"], ["IS", "–ò—Å–ª–∞–Ω–¥–∏—è"], ["IN", "–ò–Ω–¥–∏—è"], ["ID", "–ò–Ω–¥–æ–Ω–µ–∑–∏—è"],
        ["IR", "–ò—Ä–∞–Ω"], ["IQ", "–ò—Ä–∞–∫"], ["IE", "–ò—Ä–ª–∞–Ω–¥–∏—è"], ["IL", "–ò–∑—Ä–∞–∏–ª—å"], ["IT", "–ò—Ç–∞–ª–∏—è"],
        ["JP", "–Ø–ø–æ–Ω–∏—è"], ["KZ", "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω"], ["KE", "–ö–µ–Ω–∏—è"], ["KR", "–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è"], ["KG", "–ö–∏—Ä–≥–∏–∑–∏—è"],
        ["LV", "–õ–∞—Ç–≤–∏—è"], ["LB", "–õ–∏–≤–∞–Ω"], ["LT", "–õ–∏—Ç–≤–∞"], ["LU", "–õ—é–∫—Å–µ–º–±—É—Ä–≥"], ["MY", "–ú–∞–ª–∞–π–∑–∏—è"],
        ["MX", "–ú–µ–∫—Å–∏–∫–∞"], ["MD", "–ú–æ–ª–¥–æ–≤–∞"], ["MC", "–ú–æ–Ω–∞–∫–æ"], ["ME", "–ß–µ—Ä–Ω–æ–≥–æ—Ä–∏—è"], ["MA", "–ú–∞—Ä–æ–∫–∫–æ"],
        ["NL", "–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã"], ["NZ", "–ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è"], ["NG", "–ù–∏–≥–µ—Ä–∏—è"], ["MK", "–°–µ–≤–µ—Ä–Ω–∞—è –ú–∞–∫–µ–¥–æ–Ω–∏—è"],
        ["NO", "–ù–æ—Ä–≤–µ–≥–∏—è"], ["PK", "–ü–∞–∫–∏—Å—Ç–∞–Ω"], ["PA", "–ü–∞–Ω–∞–º–∞"], ["PE", "–ü–µ—Ä—É"], ["PH", "–§–∏–ª–∏–ø–ø–∏–Ω—ã"],
        ["PL", "–ü–æ–ª—å—à–∞"], ["PT", "–ü–æ—Ä—Ç—É–≥–∞–ª–∏—è"], ["QA", "–ö–∞—Ç–∞—Ä"], ["RO", "–†—É–º—ã–Ω–∏—è"], ["RU", "–†–æ—Å—Å–∏—è"],
        ["SA", "–°–∞—É–¥–æ–≤—Å–∫–∞—è –ê—Ä–∞–≤–∏—è"], ["RS", "–°–µ—Ä–±–∏—è"], ["SG", "–°–∏–Ω–≥–∞–ø—É—Ä"], ["SK", "–°–ª–æ–≤–∞–∫–∏—è"], ["SI", "–°–ª–æ–≤–µ–Ω–∏—è"],
        ["ZA", "–Æ–ê–†"], ["ES", "–ò—Å–ø–∞–Ω–∏—è"], ["LK", "–®—Ä–∏-–õ–∞–Ω–∫–∞"], ["SE", "–®–≤–µ—Ü–∏—è"], ["CH", "–®–≤–µ–π—Ü–∞—Ä–∏—è"],
        ["SY", "–°–∏—Ä–∏—è"], ["TW", "–¢–∞–π–≤–∞–Ω—å"], ["TH", "–¢–∞–∏–ª–∞–Ω–¥"], ["TJ", "–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω"], ["TN", "–¢—É–Ω–∏—Å"],
        ["TR", "–¢—É—Ä—Ü–∏—è"], ["TM", "–¢—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω"], ["UA", "–£–∫—Ä–∞–∏–Ω–∞"], ["AE", "–û–ê–≠"], ["GB", "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è"],
        ["US", "–°–®–ê"], ["UZ", "–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω"], ["VE", "–í–µ–Ω–µ—Å—É—ç–ª–∞"], ["VN", "–í—å–µ—Ç–Ω–∞–º"], ["YE", "–ô–µ–º–µ–Ω"]
        // –î–æ–±–∞–≤—å –±–æ–ª—å—à–µ —Å—Ç—Ä–∞–Ω –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    ]);

    const getCountryNameRU = (code) => countryNamesRU.get(code) || code || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

    const request = (url) => new Promise((resolve, reject) => {
        GM_xmlhttpRequest({
            method: "GET",
            url: url,
            onload: (res) => {
                try {
                    resolve(JSON.parse(res.responseText));
                } catch {
                    reject("–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ JSON");
                }
            },
            onerror: (e) => reject(e)
        });
    });

    async function run() {
        try {
            const ipResp = await request("https://api.ipify.org?format=json");
            const ip = ipResp.ip;

            const geo = await request(`https://api.ipdata.co/${ip}?api-key=c6d4d04d5f11f2cd0839ee03c47c58621d74e361c945b5c1b4f668f3`);

            const {
                city, region, country_code: cc, asn, organisation, timezone, latitude, longitude
            } = geo;

            const flag = getFlagEmoji(cc);
            const ruCountry = getCountryNameRU(cc);

            alert(
                `üõ∞ IP: ${ip}\n` +
                `${flag} –°—Ç—Ä–∞–Ω–∞: ${ruCountry} (${cc})\n` +
                `üèô –ì–æ—Ä–æ–¥: ${city || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}, ${region || ""}\n` +
                `üåê –ü—Ä–æ–≤–∞–π–¥–µ—Ä: ${asn?.name || organisation || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}\n` +
                `üïì –í—Ä–µ–º—è: ${timezone || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}\n` +
                `üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${latitude}, ${longitude}`
            );

        } catch (e) {
            alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: " + e);
        }
    }

    run();
})();
